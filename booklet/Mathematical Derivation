# Mathematical Derivations of the scQDiff Framework

This document provides a comprehensive, step-by-step mathematical derivation of the core **scQDiff** pipeline‚Äîfrom the initial determination of the drift field to the simulation of controlled cellular trajectories.

---

## 1. The Stochastic Differential Equation (SDE) Framework

The fundamental assumption of scQDiff is that the state of a cell, represented by its gene-expression vector **x ‚àà ‚Ñù<sup>G</sup>**, evolves over time according to a stochastic differential equation (SDE):

\[
d\mathbf{x}_t = f(\mathbf{x}_t, t)\,dt + \sqrt{2\varepsilon}\,d\mathbf{W}_t
\]

where:

- **x‚Çú** ‚Äî gene-expression state at time *t*  
- **f(x‚Çú, t)** ‚Äî *drift field*, a time-varying vector field representing the deterministic component of cellular dynamics (average velocity in gene-expression space)  
- **Œµ** ‚Äî diffusion coefficient (magnitude of stochasticity or noise)  
- **dW‚Çú** ‚Äî standard Wiener process (Brownian motion)

---

## 2. Step 1 ‚Äì Determination of the Drift Field *f(x, t)*

### Method A: Velocity-Constrained Field Learning

Used when RNA-velocity information is available.

1. **RNA Velocity.**  
   From unspliced/spliced mRNA ratios we estimate per-cell velocity vectors  
   \[
   v_i \approx f(x_i,t_i),
   \]
   noisy empirical samples of the true drift.

2. **Neural-Network Parameterization.**  
   Parameterize the drift with a neural network \(f_Œ∏(x,t)\) mapping cell state and pseudotime to a *G*-dimensional drift vector.

3. **Loss Function.**  
   Learn parameters Œ∏ by minimizing  
   \[
   \mathcal{L}_{\text{vel}}(Œ∏) =
   \mathbb{E}_{x,t}\big[\,\|f_Œ∏(x,t)-\hat v(x)\|_2^2\,\big]
   + Œª_{\text{graph}}\!\!\sum_{i,j}\!W_{ij}\|f_Œ∏(x_i,t)-f_Œ∏(x_j,t)\|_2^2
   + Œª_{\text{wd}}\|\theta\|_2^2 .
   \]

### Method B: Bridge-Lite (Schr√∂dinger Bridge in Latent Space)

Used when velocity data are absent.

1. **Problem Setup.**  
   Given start/end distributions œÅ‚ÇÄ and œÅ‚ÇÅ, find the most probable stochastic process connecting them‚Äîthe **Schr√∂dinger Bridge** problem.

2. **Entropic Optimal Transport.**  
   Solve  
   \[
   \min_{\pi}\;\mathbb{E}_\pi[c(x_0,x_1)] + \varepsilon\,\text{KL}(\pi\|\pi_{\text{ref}})
   \]
   to obtain an optimal coupling œÄ between œÅ‚ÇÄ and œÅ‚ÇÅ.

3. **Drift from OT Plan.**  
   Approximate the drift from gradients of the Kantorovich potentials; learn \(f(x,t)\) in a latent (e.g., VAE) space that pushes samples along OT paths.

---

## 3. Step 2 ‚Äì Computation of the Temporal Jacobian Tensor ùìô

After learning *f(x,t)*, compute its Jacobian to quantify local gene‚Äìgene interactions.

1. **Definition.**  
   \[
   J_{ij}(t) = \frac{\partial f_i(x,t)}{\partial x_j},
   \qquad
   J(t)\in\mathbb{R}^{G\times G}.
   \]

2. **Computation.**
   - If *f* is a differentiable neural network, compute *J* exactly using automatic differentiation.  
   - If not analytical, estimate *J* locally via ridge regression on nearby drift vectors.

3. **Tensor Assembly.**  
   Evaluate *J(t)* at discrete time points \(t_1,\dots,t_T\) to obtain the **temporal Jacobian tensor**  
   \[
   \mathcal{J}\in\mathbb{R}^{G\times G\times T}.
   \]

---

## 4. Step 3 ‚Äì Extraction of Regulatory Archetypes

Decompose ùìô into interpretable dynamical modules.

1. **Tensor Unfolding.**  
   Flatten ùìô into \(J_{\text{unfold}}\in\mathbb{R}^{G^2\times T}\) where each column is *J(t‚Çñ)*.

2. **Singular-Value Decomposition (SVD).**  
   \[
   J_{\text{unfold}} = U\,\Sigma\,V^T.
   \]

3. **Archetype Extraction.**
   - Regulatory archetype \(M_k \in \mathbb{R}^{G\times G}\) ‚Üê reshape k-th column of *U*.  
   - Temporal activation \(a_k(t)\) ‚Üê k-th row of Œ£ V·µÄ.

4. **Reconstruction.**  
   \[
   \mathcal{J}(t)\approx\sum_{k=1}^K a_k(t)\,M_k .
   \]
   The \(M_k\) capture time-in_
